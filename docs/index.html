<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@^1.23.1"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <meta charset="UTF-8">
    <title>SCHmUBERT</title>
</head>
<body>
<script>
    const ORIGINAL_PROGRAMS = [0, 33];
    const N_SAMPLES = 1000;
    let PROGRAMS = [...ORIGINAL_PROGRAMS];
    (async  () =>
    {
        const SF_URL = 'https://storage.googleapis.com/magentadata/js/soundfonts/sgm_plus';
        const SAMPLES_BASE_URL = 'https://raw.githubusercontent.com/plassma/symbolic-music-discrete-diffusion/master/samples/';

        updateNoteseq = async(path) => {
            await stop();
            let url = SAMPLES_BASE_URL;
            if(typeof path !== 'string') {
                let dataset = $("#sel-set").val();
                let tracks = $("#sel-tracks").val();
                let idx = $('#sel-sample').val();
                url += dataset + '/' + tracks + `/sample_${idx}.mid`
            } else {
                url += path;
            }
            let ns = await mm.urlToNoteSequence(url);

            for(let i = 0; i < ns.notes.length; i++){
                for(let j = 0; j < 2; j++) {
                    if (ns.notes[i].program === ORIGINAL_PROGRAMS[j]) {
                        ns.notes[i].program = PROGRAMS[j];
                    }
                }
            }

            viz.noteSequence = ns;
            viz.redraw();
            return ns;
        }

        const popSelects = async () => {
            const response = await (await fetch(SF_URL + '/soundfont.json')).json();
            const instruments = Object.values(response.instruments);
            const selects = $("select.select");
            for (let i = 0; i < selects.length; i++) {
                selects[i].innerHTML = instruments.map((e, j) => `<option ${j === PROGRAMS[i] ? 'selected' : ''}>${e}</option>`).join('');
                $(selects[i]).change(() => console.log(PROGRAMS[i] = $(selects[i])[0].selectedIndex));
            }
            let sel_sample = $("#sel-sample")[0];
            sel_sample.innerHTML = [...Array(N_SAMPLES).keys()].map(v => `<option>${v}</option>`).join('');
            $("#sel-sample").change(updateNoteseq);
            $("#sel-tracks").change(updateNoteseq);
            $("#sel-set").change(updateNoteseq);
        };
        popSelects();

        let ns = await mm.urlToNoteSequence('https://raw.githubusercontent.com/plassma/symbolic-music-discrete-diffusion/master/samples/generated/melody/sample_0.mid');
        const viz = new mm.PianoRollCanvasVisualizer(ns, document.getElementById('viz-notes'), {minPitch: 21, maxPitch: 90});
        const player = new mm.SoundFontPlayer(SF_URL, undefined,
            undefined, undefined, {
                run: (note) => viz.redraw(note),
                stop: () => {
                    console.log('done');
                }
            })

        play = async (path) => {
            let ns = await updateNoteseq(path);
            player.start(ns)
        };
        stop = async () => {
            player.stop();
        }

    })();
</script>
<canvas id="viz-notes" width="1024" height="800"></canvas>
<div>
    <button onclick="play()">play</button>
    <button onclick="stop()">stop</button>
</div>
    <div style="display: block">
    <div>
        <label for="select-melody">Melody Instrument:</label><select id="select-melody" class="select"></select>
        <label for="select-bass">Bass Instrument:</label><select id="select-bass" class="select"></select>
    </div>
    <div>
        <label for="sel-set">Dataset:</label>
        <select id="sel-set">
            <option>generated</option>
            <option>train</option>
            <option>valid</option>
        </select>
        <label for="sel-tracks">Tracks:</label>
        <select id="sel-tracks">
            <option>melody</option>
            <option>trio</option>
        </select>
        <label for="sel-sample">Sample #:</label>
        <select id="sel-sample">
        </select>
    </div>
    <div style="margin-top: 20px;">
        <p>Welcome to the SCHmUBERT samples demo page!
        You are free to explore samples generated by SCHmUBERT, and also to take a look at the data that was used to train SCHmUBERT (train/valid).<br/>
        Additionally, we provide a minimal hand-selection, the following samples were generated unconditionally:
            <button onclick="play('selected/melody_0.mid')">Selected melody piece</button>
            <button onclick="play('selected/trio_0.mid')">Selected trio piece</button>
        </p>
        <p>
            In the following sample, we demonstrate SCHmUBERT's conditional infilling:
            We provided a melody only track with a length of 71s, and let SCHmUBERT fill in notes.<br/>
            In addition to extending the piece to a length of 128s, SCHmUBERT filled in a bass and a drum track.

            <button onclick="play('selected/mario_original.mid')">Original Mario Piece</button>
            <button onclick="play('selected/mario_outpainted.mid')">Accompanied, outpainted Mario Piece</button>
        </p>
    </div>
</div>
</body>
</html>